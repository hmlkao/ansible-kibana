---
- name: os-specific vars
  include_vars: "{{ ansible_os_family }}.yml"
  tags:
    - always

- name: check-set-parameters
  import_tasks: kibana-parameters.yml
  tags:
    - always

- import_tasks: java.yml
  when: kibana_java_install
  tags:
    - java

- import_tasks: kibana.yml
  tags:
    - install

- import_tasks: kibana-config.yml
  tags:
    - config

#- include_tasks: kibana-plugins.yml
#  when: kibana_plugins is defined or kibana_plugins_reinstall
#  tags:
#    - plugins

# We always execute xpack as we may need to remove features
# There can be a problem during installation
#    Plugin installation was unsuccessful due to error "ENOENT: no such file or directory, open '/usr/share/kibana/config/kibana.yml'"
# But kibana.yml is placed in /etc/kibana subfolder
- import_tasks: xpack/kibana-xpack.yml
  tags:
    - xpack

- meta: flush_handlers

- name: Make sure Kibana is started
  service: name={{ instance_init_script | basename }} state=started enabled=yes
  when: kibana_start_service

- name: Wait for Kibana to startup
  wait_for: host={{ kibana_config['server.host'] | default('localhost') }} port={{ kibana_config['server.port'] | default('5601') }} delay=5 connect_timeout=1
  when: kibana_restarted is defined and kibana_restarted.changed and kibana_start_service
